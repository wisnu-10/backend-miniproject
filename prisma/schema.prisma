// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---
enum UserRole {
  CUSTOMER
  ORGANIZER
}

enum TransactionStatus {
  WAITING_PAYMENT
  WAITING_CONFIRMATION
  DONE
  REJECTED
  EXPIRED
  CANCELLED
}

// --- TABLES ---
model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  full_name       String
  phone_number    String?
  profile_picture String?
  role            UserRole
  referral_code   String    @unique
  referred_by     String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  deleted_at      DateTime? // Soft delete

  // Relations
  events       Event[]
  transactions Transaction[]
  coupons      Coupon[]
  points       Point[]
  reviews      Review[]

  // Indexes
  @@index([email])
  @@index([referral_code])
  @@index([role])
  @@index([deleted_at])
  @@map("users")
}

model Event {
  id              String    @id @default(uuid())
  organizer_id    String
  name            String
  description     String    @db.Text
  category        String
  city            String?
  province        String?
  start_date      DateTime
  end_date        DateTime
  total_seats     Int
  available_seats Int
  base_price      Decimal   @db.Decimal(12, 2)
  is_free         Boolean   @default(false)
  image           String?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  deleted_at      DateTime? // Soft delete

  // Relations
  organizer     User              @relation(fields: [organizer_id], references: [id], onDelete: Cascade)
  ticket_types  TicketType[]
  promotions    Promotion[]
  transactions  Transaction[]
  reviews       Review[]

  // Indexes
  @@index([organizer_id])
  @@index([category])
  @@index([city])
  @@index([start_date])
  @@index([end_date])
  @@index([deleted_at])
  @@index([is_free])
  @@map("events")
}

model TicketType {
  id                 String   @id @default(uuid())
  event_id           String
  name               String
  description        String?  @db.Text
  price              Decimal  @db.Decimal(12, 2)
  quantity           Int
  available_quantity Int
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  // Relations
  event             Event              @relation(fields: [event_id], references: [id], onDelete: Cascade)
  transaction_items TransactionItem[]

  // Indexes
  @@index([event_id])
  @@map("ticket_types")
}

model Promotion {
  id                  String    @id @default(uuid())
  event_id            String
  code                String    @unique
  discount_percentage Decimal?  @db.Decimal(5, 2)
  discount_amount     Decimal?  @db.Decimal(12, 2)
  max_usage           Int
  current_usage       Int       @default(0)
  valid_from          DateTime
  valid_until         DateTime
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  // Relations
  event        Event         @relation(fields: [event_id], references: [id], onDelete: Cascade)
  transactions Transaction[]

  // Indexes
  @@index([event_id])
  @@index([code])
  @@index([valid_from, valid_until])
  @@map("promotions")
}

model Coupon {
  id                  String    @id @default(uuid())
  user_id             String
  code                String    @unique
  discount_percentage Decimal?  @db.Decimal(5, 2)
  discount_amount     Decimal?  @db.Decimal(12, 2)
  valid_from          DateTime
  valid_until         DateTime
  is_used             Boolean   @default(false)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  // Relations
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  transactions Transaction[]

  // Indexes
  @@index([user_id])
  @@index([code])
  @@index([is_used])
  @@index([valid_from, valid_until])
  @@map("coupons")
}

model Point {
  id               String   @id @default(uuid())
  user_id          String
  amount           Int // Jumlah poin yang didapat
  remaining_amount Int // Sisa poin yang belum terpakai
  expires_at       DateTime
  created_at       DateTime @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  // Indexes
  @@index([user_id])
  @@index([expires_at])
  @@index([user_id, expires_at])
  @@map("points")
}

model Transaction {
  id              String            @id @default(uuid())
  user_id         String
  event_id        String
  invoice_number  String            @unique
  total_amount    Decimal           @db.Decimal(12, 2)
  discount_amount Decimal           @default(0) @db.Decimal(12, 2)
  points_used     Int               @default(0)
  final_amount    Decimal           @db.Decimal(12, 2)
  promotion_id    String?
  coupon_id       String?
  status          TransactionStatus @default(WAITING_PAYMENT)
  payment_proof   String?
  payment_deadline DateTime
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt

  // Relations
  user      User              @relation(fields: [user_id], references: [id], onDelete: Restrict)
  event     Event             @relation(fields: [event_id], references: [id], onDelete: Restrict)
  promotion Promotion?        @relation(fields: [promotion_id], references: [id], onDelete: SetNull)
  coupon    Coupon?           @relation(fields: [coupon_id], references: [id], onDelete: SetNull)
  items     TransactionItem[]

  // Indexes
  @@index([user_id])
  @@index([event_id])
  @@index([invoice_number])
  @@index([status])
  @@index([created_at])
  @@index([payment_deadline])
  @@index([promotion_id])
  @@index([coupon_id])
  @@map("transactions")
}

model TransactionItem {
  id              String   @id @default(uuid())
  transaction_id  String
  ticket_type_id  String
  quantity        Int
  price_at_buy    Decimal  @db.Decimal(12, 2)
  subtotal        Decimal  @db.Decimal(12, 2)
  created_at      DateTime @default(now())

  // Relations
  transaction Transaction @relation(fields: [transaction_id], references: [id], onDelete: Cascade)
  ticket_type TicketType  @relation(fields: [ticket_type_id], references: [id], onDelete: Restrict)

  // Indexes
  @@index([transaction_id])
  @@index([ticket_type_id])
  @@map("transaction_items")
}

model Review {
  id         String   @id @default(uuid())
  user_id    String
  event_id   String
  rating     Int      // Sebaiknya tambahkan constraint 1-5
  comment    String   @db.Text
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  user  User  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  event Event @relation(fields: [event_id], references: [id], onDelete: Cascade)

  // Constraints
  @@unique([user_id, event_id]) // 1 user 1 review per event
  @@index([event_id])
  @@index([rating])
  @@map("reviews")
}